# ============================================================================
# Azure DevOps Pipeline - Simplified for Personal Project
# ============================================================================
# D·ª± √°n: WebApp.Controller (E-commerce Backend)
# Framework: .NET 8.0
# Database: SQL Server with Entity Framework Core
# Deploy Target: Azure App Service
# ============================================================================

trigger:
  branches:
    include:
      - main  # Ch·ªâ trigger khi push v√†o main branch

# Kh√¥ng ch·∫°y pipeline cho Pull Request
pr: none

# ============================================================================
# VARIABLES
# ============================================================================
variables:
  # Build settings
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  
  # Project paths
  solution: 'WebApp.Controller.sln'
  webProject: 'WebApp.Controller/WebApp.Controller.csproj'
  
  # Artifact name
  artifactName: 'webapp-drop'
  
  # Azure settings - THAY ƒê·ªîI C√ÅC GI√Å TR·ªä N√ÄY
  azureSubscription: 'Azure-ServiceConnection'  # T√™n Service Connection trong Azure DevOps
  appServiceName: 'webapp-appservice'           # T√™n App Service tr√™n Azure
  resourceGroupName: 'webapp-rg'                # T√™n Resource Group
  
  # Variable Group ch·ª©a secrets
  - group: 'WebApp-Secrets'

# ============================================================================
# STAGES
# ============================================================================
stages:

# ----------------------------------------------------------------------------
# STAGE 1: BUILD
# ----------------------------------------------------------------------------
- stage: Build
  displayName: 'Build Application'
  jobs:
  - job: BuildJob
    displayName: 'Build & Package'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    # B∆∞·ªõc 1: C√†i ƒë·∫∑t .NET SDK
    - task: UseDotNetCore@2
      displayName: 'üì¶ Install .NET SDK 8.0'
      inputs:
        version: $(dotnetVersion)
        packageType: 'sdk'
    
    # B∆∞·ªõc 2: Restore dependencies
    - task: DotNetCoreCLI@2
      displayName: 'üì• Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: '$(solution)'
    
    # B∆∞·ªõc 3: Build solution
    - task: DotNetCoreCLI@2
      displayName: 'üî® Build Solution'
      inputs:
        command: 'build'
        projects: '$(solution)'
        arguments: '--configuration $(buildConfiguration) --no-restore'
    
    # B∆∞·ªõc 4: Publish application
    - task: DotNetCoreCLI@2
      displayName: 'üì¶ Publish Application'
      inputs:
        command: 'publish'
        publishWebProjects: false
        projects: '$(webProject)'
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/app --no-build'
        zipAfterPublish: true
    
    # B∆∞·ªõc 5: Copy migration project
    - task: CopyFiles@2
      displayName: 'üìã Copy Migration Files'
      inputs:
        sourceFolder: '$(Build.SourcesDirectory)/WebApp.Model'
        contents: |
          **/*.csproj
          **/*.cs
        targetFolder: '$(Build.ArtifactStagingDirectory)/migrations'
    
    # B∆∞·ªõc 6: Copy Helper project (dependency)
    - task: CopyFiles@2
      displayName: 'üìã Copy Helper Files'
      inputs:
        sourceFolder: '$(Build.SourcesDirectory)/WebApp.Helper'
        contents: |
          **/*.csproj
          **/*.cs
        targetFolder: '$(Build.ArtifactStagingDirectory)/helper'
    
    # B∆∞·ªõc 7: Publish artifacts
    - task: PublishBuildArtifacts@1
      displayName: '‚¨ÜÔ∏è Publish Artifacts'
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: '$(artifactName)'

# ----------------------------------------------------------------------------
# STAGE 2: DEPLOY
# ----------------------------------------------------------------------------
- stage: Deploy
  displayName: 'Deploy to Azure'
  dependsOn: Build
  condition: succeeded()
  
  jobs:
  - deployment: DeployJob
    displayName: 'Deploy Application'
    environment: 'production'  # T·∫°o environment n√†y trong Azure DevOps
    pool:
      vmImage: 'ubuntu-latest'
    
    strategy:
      runOnce:
        deploy:
          steps:
          # B∆∞·ªõc 1: Download artifacts
          - download: current
            artifact: $(artifactName)
            displayName: 'üì• Download Build Artifacts'
          
          # B∆∞·ªõc 2: Install EF Core Tools
          - task: UseDotNetCore@2
            displayName: 'üì¶ Install .NET SDK'
            inputs:
              version: $(dotnetVersion)
          
          - script: |
              dotnet tool install --global dotnet-ef --version 9.0.10
              export PATH="$PATH:$HOME/.dotnet/tools"
              echo "EF Core version:"
              dotnet ef --version
            displayName: 'üîß Install EF Core Tools'
          
          # B∆∞·ªõc 3: Configure App Service Settings
          - task: AzureAppServiceSettings@1
            displayName: '‚öôÔ∏è Configure App Settings'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appName: '$(appServiceName)'
              resourceGroupName: '$(resourceGroupName)'
              appSettings: |
                [
                  {
                    "name": "ASPNETCORE_ENVIRONMENT",
                    "value": "Production",
                    "slotSetting": false
                  },
                  {
                    "name": "ConnectionStrings__Web",
                    "value": "$(ConnectionStrings.Web)",
                    "slotSetting": false
                  },
                  {
                    "name": "Jwt__Key",
                    "value": "$(Jwt.Key)",
                    "slotSetting": false
                  },
                  {
                    "name": "Jwt__Issuer",
                    "value": "$(Jwt.Issuer)",
                    "slotSetting": false
                  },
                  {
                    "name": "Jwt__Audience",
                    "value": "$(Jwt.Audience)",
                    "slotSetting": false
                  },
                  {
                    "name": "CloudflareR2__AccessKeyId",
                    "value": "$(CloudflareR2.AccessKeyId)",
                    "slotSetting": false
                  },
                  {
                    "name": "CloudflareR2__SecretAccess",
                    "value": "$(CloudflareR2.SecretAccess)",
                    "slotSetting": false
                  },
                  {
                    "name": "CloudflareR2__BucketName",
                    "value": "$(CloudflareR2.BucketName)",
                    "slotSetting": false
                  },
                  {
                    "name": "CloudflareR2__Endpoint",
                    "value": "$(CloudflareR2.Endpoint)",
                    "slotSetting": false
                  },
                  {
                    "name": "CloudflareR2__PublicUrl",
                    "value": "$(CloudflareR2.PublicUrl)",
                    "slotSetting": false
                  },
                  {
                    "name": "Momo__PartnerCode",
                    "value": "$(Momo.PartnerCode)",
                    "slotSetting": false
                  },
                  {
                    "name": "Momo__AccessKey",
                    "value": "$(Momo.AccessKey)",
                    "slotSetting": false
                  },
                  {
                    "name": "Momo__SecretKey",
                    "value": "$(Momo.SecretKey)",
                    "slotSetting": false
                  },
                  {
                    "name": "Momo__Endpoint",
                    "value": "$(Momo.Endpoint)",
                    "slotSetting": false
                  },
                  {
                    "name": "Momo__NotifyUrl",
                    "value": "$(Momo.NotifyUrl)",
                    "slotSetting": false
                  },
                  {
                    "name": "Momo__ReturnUrl",
                    "value": "$(Momo.ReturnUrl)",
                    "slotSetting": false
                  }
                ]
          
          # B∆∞·ªõc 4: Run Database Migrations
          - script: |
              export PATH="$PATH:$HOME/.dotnet/tools"
              
              echo "üóÑÔ∏è Running database migrations..."
              cd $(Pipeline.Workspace)/$(artifactName)/migrations
              
              # Restore packages
              dotnet restore
              
              # Run migrations
              dotnet ef database update \
                --project . \
                --connection "$(ConnectionStrings.Web)" \
                --verbose
              
              echo "‚úÖ Migrations completed successfully!"
            displayName: 'üóÑÔ∏è Run EF Core Migrations'
            env:
              ConnectionStrings__Web: $(ConnectionStrings.Web)
            continueOnError: false
          
          # B∆∞·ªõc 5: Deploy to Azure App Service
          - task: AzureWebApp@1
            displayName: 'üöÄ Deploy to Azure App Service'
            inputs:
              azureSubscription: '$(azureSubscription)'
              appType: 'webAppLinux'
              appName: '$(appServiceName)'
              package: '$(Pipeline.Workspace)/$(artifactName)/app/**/*.zip'
              deploymentMethod: 'auto'
          
          # B∆∞·ªõc 6: Verify deployment (Optional)
          - script: |
              echo "‚è≥ Waiting for app to start..."
              sleep 30
              
              echo "üîç Verifying deployment..."
              APP_URL="https://$(appServiceName).azurewebsites.net"
              
              response=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL/weatherforecast)
              
              if [ $response -eq 200 ] || [ $response -eq 401 ]; then
                echo "‚úÖ Deployment verified! App is responding (HTTP $response)"
                echo "üåê App URL: $APP_URL"
                exit 0
              else
                echo "‚ö†Ô∏è Warning: App returned HTTP $response"
                echo "Check app logs if needed"
                exit 0
              fi
            displayName: '‚úÖ Verify Deployment'
            continueOnError: true